{% extends "base.html" %}

{% block title %}Enhanced Dashboard - Study Streak Motivator{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container">
        <h1 class="page-title">📊 Your Study Analytics Dashboard</h1>
        <p class="page-subtitle">Advanced insights to supercharge your learning journey!</p>
        
        {% if data %}
        <!-- Top Stats Overview -->
        <div class="stats-overview stagger-animation">
            <div class="stat-card streak-card animate-on-scroll{% if data.streak_status == 'at_risk' %} streak-at-risk{% elif data.streak_status == 'broken_today' %} streak-broken{% elif data.has_studied_today %} streak-active{% endif %}">
                <div class="stat-icon">🔥</div>
                <div class="stat-content">
                    <div class="stat-number animated-counter" data-target="{{ data.current_streak }}">{{ data.current_streak }}</div>
                    <div class="stat-label">Day Streak</div>
                    {% if data.longest_streak > data.current_streak %}
                        <div class="stat-sublabel">Best: {{ data.longest_streak }} days</div>
                    {% elif data.current_streak > 0 %}
                        <div class="stat-sublabel">🎉 Personal Record!</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="stat-card animate-on-scroll">
                <div class="stat-icon">⏱️</div>
                <div class="stat-content">
                    <div class="stat-number animated-counter" data-target="{{ (data.total_study_time / 60)|round(1) }}">{{ (data.total_study_time / 60)|round(1) }}</div>
                    <div class="stat-label">Total Hours</div>
                    <div class="stat-sublabel">{{ data.total_study_time }} minutes</div>
                </div>
            </div>
            
            <div class="stat-card animate-on-scroll">
                <div class="stat-icon">📚</div>
                <div class="stat-content">
                    <div class="stat-number animated-counter" data-target="{{ data.total_sessions }}">{{ data.total_sessions }}</div>
                    <div class="stat-label">Sessions</div>
                    <div class="stat-sublabel"><span class="animated-counter" data-target="{{ data.weekly_comparison.this_week }}">{{ data.weekly_comparison.this_week }}</span> min this week</div>
                </div>
            </div>
            
            <div class="stat-card animate-on-scroll">
                <div class="stat-icon">🏆</div>
                <div class="stat-content">
                    <div class="stat-number animated-counter" data-target="{{ data.earned_badges|length }}">{{ data.earned_badges|length }}</div>
                    <div class="stat-label">Badges</div>
                    <div class="stat-sublabel">Achievements unlocked</div>
                </div>
            </div>
        </div>

        <!-- Goal Progress Section -->
        <div class="dashboard-section">
            <h2 class="section-title">🎯 Goal Progress</h2>
            <div class="goals-container stagger-animation">
                <div class="goal-card animate-on-scroll">
                    <h3>📅 Daily Goal</h3>
                    <div class="progress-circle" data-progress="{{ data.goal_progress.daily.progress_percent }}">
                        <div class="progress-inner">
                            <span class="progress-text animated-counter" data-target="{{ data.goal_progress.daily.progress_percent|round(0) }}">{{ data.goal_progress.daily.progress_percent|round(0) }}</span>
                        </div>
                    </div>
                    <p><span class="animated-counter" data-target="{{ data.goal_progress.daily.current }}">{{ data.goal_progress.daily.current }}</span> / <span class="animated-counter" data-target="{{ data.goal_progress.daily.goal }}">{{ data.goal_progress.daily.goal }}</span> minutes</p>
                    {% if data.goal_progress.daily.completed %}
                        <span class="goal-status completed">✅ Completed!</span>
                    {% else %}
                        <span class="goal-status pending">{{ data.goal_progress.daily.goal - data.goal_progress.daily.current }} min remaining</span>
                    {% endif %}
                </div>
                
                <div class="goal-card animate-on-scroll">
                    <h3>📊 Weekly Goal</h3>
                    <div class="progress-circle" data-progress="{{ data.goal_progress.weekly.progress_percent }}">
                        <div class="progress-inner">
                            <span class="progress-text animated-counter" data-target="{{ data.goal_progress.weekly.progress_percent|round(0) }}">{{ data.goal_progress.weekly.progress_percent|round(0) }}</span>
                        </div>
                    </div>
                    <p><span class="animated-counter" data-target="{{ data.goal_progress.weekly.current }}">{{ data.goal_progress.weekly.current }}</span> / <span class="animated-counter" data-target="{{ data.goal_progress.weekly.goal }}">{{ data.goal_progress.weekly.goal }}</span> minutes</p>
                    {% if data.goal_progress.weekly.completed %}
                        <span class="goal-status completed">✅ Completed!</span>
                    {% else %}
                        <span class="goal-status pending">{{ data.goal_progress.weekly.goal - data.goal_progress.weekly.current }} min remaining</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="dashboard-section">
            <h2 class="section-title">📈 Study Trends</h2>
            <div class="charts-container stagger-animation">
                <div class="chart-card animate-on-scroll">
                    <h3>Study Time Trend (Last 14 Days)</h3>
                    <canvas id="studyTrendChart" width="400" height="200" class="chart-element"></canvas>
                </div>
                
                <div class="chart-card animate-on-scroll">
                    <h3>Study Hours Analysis</h3>
                    <canvas id="hourlyChart" width="400" height="200" class="chart-element"></canvas>
                </div>
            </div>
        </div>

        <!-- Weekly Comparison -->
        <div class="dashboard-section">
            <h2 class="section-title">📊 Weekly Performance</h2>
            <div class="weekly-comparison">
                <div class="comparison-card animate-on-scroll">
                    <h3>This Week vs Last Week</h3>
                    <div class="comparison-stats">
                        <div class="week-stat">
                            <span class="week-label">This Week</span>
                            <span class="week-value animated-counter" data-target="{{ data.weekly_comparison.this_week }}">{{ data.weekly_comparison.this_week }}</span>
                        </div>
                        <div class="trend-indicator trend-{{ data.weekly_comparison.trend }}">
                            {% if data.weekly_comparison.trend == 'up' %}
                                <span class="trend-icon">📈</span>
                                <span class="trend-text">+{{ data.weekly_comparison.change_percent }}%</span>
                            {% elif data.weekly_comparison.trend == 'down' %}
                                <span class="trend-icon">📉</span>
                                <span class="trend-text">{{ data.weekly_comparison.change_percent }}%</span>
                            {% else %}
                                <span class="trend-icon">➡️</span>
                                <span class="trend-text">No change</span>
                            {% endif %}
                        </div>
                        <div class="week-stat">
                            <span class="week-label">Last Week</span>
                            <span class="week-value animated-counter" data-target="{{ data.weekly_comparison.last_week }}">{{ data.weekly_comparison.last_week }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subject Breakdown with Charts -->
        {% if data.subject_stats %}
        <div class="dashboard-section">
            <h2 class="section-title">📚 Subject Performance</h2>
            <div class="subject-analytics">
                <div class="chart-card">
                    <h3>Subject Distribution</h3>
                    <canvas id="subjectChart" width="300" height="300"></canvas>
                </div>
                <div class="subject-details">
                    {% for stat in data.subject_stats %}
                    <div class="subject-item">
                        <div class="subject-info">
                            <h4>{{ stat.subject }}</h4>
                            <p>{{ stat.total_minutes }} minutes ({{ (stat.total_minutes / 60)|round(1) }} hours)</p>
                            <p class="session-count">{{ stat.session_count }} session{{ 's' if stat.session_count != 1 else '' }}</p>
                        </div>
                        <div class="subject-progress">
                            {% set total_time = data.subject_stats | sum(attribute='total_minutes') %}
                            {% set percentage = (stat.total_minutes / total_time * 100) if total_time > 0 else 0 %}
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ percentage }}%"></div>
                            </div>
                            <span class="percentage">{{ percentage|round(1) }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Interactive Study Calendar -->
        <div class="dashboard-section">
            <h2 class="section-title">📅 Study Calendar</h2>
            <div class="study-calendar" id="studyCalendar"></div>
        </div>

        <!-- Recent Activity & Insights -->
        <div class="dashboard-section">
            <h2 class="section-title">🔍 Recent Activity & Insights</h2>
            <div class="insights-container">
                <div class="insights-card">
                    <h3>💡 Smart Insights</h3>
                    <div class="insights-list">
                        {% if data.hour_analysis.peak_minutes > 0 %}
                        <div class="insight-item">
                            <span class="insight-icon">⏰</span>
                            <span class="insight-text">Your most productive time is around {{ data.hour_analysis.peak_time_display }}</span>
                        </div>
                        {% endif %}
                        
                        {% if data.weekly_comparison.trend == 'up' %}
                        <div class="insight-item">
                            <span class="insight-icon">📈</span>
                            <span class="insight-text">Great progress! You're {{ data.weekly_comparison.change_percent }}% more active than last week</span>
                        </div>
                        {% endif %}
                        
                        {% if data.current_streak >= 7 %}
                        <div class="insight-item">
                            <span class="insight-icon">🔥</span>
                            <span class="insight-text">Amazing! You've built a {{ data.current_streak }}-day study habit</span>
                        </div>
                        {% endif %}
                        
                        {% if data.goal_progress.daily.completed %}
                        <div class="insight-item">
                            <span class="insight-icon">✅</span>
                            <span class="insight-text">Daily goal achieved! Keep up the excellent work</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if data.recent_sessions %}
                <div class="recent-sessions">
                    <h3>📝 Recent Sessions</h3>
                    {% for session in data.recent_sessions[:5] %}
                    <div class="session-item">
                        <div class="session-subject">{{ session.subject }}</div>
                        <div class="session-details">
                            <span class="session-date">{{ session.session_date.strftime('%b %d') }}</span>
                            <span class="session-duration">{{ session.duration_minutes }} min</span>
                            {% if session.completed %}
                                <span class="session-status completed">✓</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="dashboard-actions">
            <a href="{{ url_for('timer') }}" class="btn btn-primary btn-lg">
                🎯 Start Study Session
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                📊 Simple Dashboard
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-outline">
                🏠 Back to Home
            </a>
        </div>

        {% else %}
        <!-- No Data State -->
        <div class="no-data-state">
            <div class="no-data-card">
                <h2>⚠️ No Data Available</h2>
                <p>Initialize the database to see your analytics dashboard.</p>
                <a href="{{ url_for('init_database') }}" class="btn btn-primary">Initialize Database</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Chart.js only for dashboard pages -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<!-- Study Calendar JavaScript -->
<script src="{{ url_for('static', filename='js/study-calendar.js') }}" defer></script>

<script>
// Dashboard Analytics JavaScript
document.addEventListener('DOMContentLoaded', function() {
    {% if data %}
    
    // Study Trend Chart
    const studyTrendCtx = document.getElementById('studyTrendChart');
    if (studyTrendCtx) {
    const trendData = {{ data.study_trends | tojson }};
        const dates = Object.keys(trendData).sort();
        const minutes = dates.map(date => trendData[date]);
        
        new Chart(studyTrendCtx, {
            type: 'line',
            data: {
                labels: dates.map(date => new Date(date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
                datasets: [{
                    label: 'Study Time (minutes)',
                    data: minutes,
                    borderColor: '#4285f4',
                    backgroundColor: 'rgba(66, 133, 244, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Minutes'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Hourly Analysis Chart
    const hourlyCtx = document.getElementById('hourlyChart');
    if (hourlyCtx) {
        const hourlyData = {{ data.hour_analysis.hourly_data | tojson }};
        const hours = Object.keys(hourlyData).map(h => parseInt(h));
        const studyMinutes = hours.map(h => hourlyData[h]);
        
        new Chart(hourlyCtx, {
            type: 'bar',
            data: {
                labels: hours.map(h => h + ':00'),
                datasets: [{
                    label: 'Study Minutes',
                    data: studyMinutes,
                    backgroundColor: 'rgba(52, 168, 83, 0.7)',
                    borderColor: '#34a853',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Minutes'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
    
    // Subject Distribution Chart
    const subjectCtx = document.getElementById('subjectChart');
    if (subjectCtx) {
        const subjectStats = {{ data.subject_stats | tojson }};
        const subjects = subjectStats.map(s => s.subject);
        const minutes = subjectStats.map(s => s.total_minutes);
        
        new Chart(subjectCtx, {
            type: 'doughnut',
            data: {
                labels: subjects,
                datasets: [{
                    data: minutes,
                    backgroundColor: [
                        '#4285f4',
                        '#34a853', 
                        '#fbbc05',
                        '#ea4335',
                        '#9c27b0',
                        '#ff9800'
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Initialize Study Calendar
    const calendarData = {{ data.study_trends | tojson }};
    if (document.getElementById('studyCalendar')) {
        const studyCalendar = new StudyCalendar('studyCalendar', calendarData);
        
        // Handle day selection
        document.getElementById('studyCalendar').addEventListener('daySelected', function(event) {
            const { date, minutes } = event.detail;
            // Could show detailed info for selected day
        });
    }
    
    // Animate Progress Circles
    const progressCircles = document.querySelectorAll('.progress-circle');
    progressCircles.forEach(circle => {
        const progress = circle.dataset.progress;
        const circumference = 2 * Math.PI * 45; // radius = 45
        const offset = circumference - (progress / 100) * circumference;
        
        // Create SVG if not exists
        if (!circle.querySelector('svg')) {
            circle.innerHTML = `
                <svg class="progress-svg" width="100" height="100">
                    <circle cx="50" cy="50" r="45" stroke="#e9ecef" stroke-width="8" fill="transparent"/>
                    <circle cx="50" cy="50" r="45" stroke="#4285f4" stroke-width="8" fill="transparent"
                        stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                        transform="rotate(-90 50 50)" class="progress-bar-circle"/>
                </svg>
                <div class="progress-inner">
                    <span class="progress-text">${Math.round(progress)}%</span>
                </div>
            `;
        }
    });
    
    {% endif %}
});
</script>
{% endblock %}